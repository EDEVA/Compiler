# MIPS 目标代码生成

目标代码生成主要由 4 个部分组成

| 类名         | 功能描述                                       |
| ------------ | ---------------------------------------------- |
| `Mips`       | 读取符号表存储的中间代码，以函数为单位翻译     |
| `ObjFunc`    | 翻译单个函数的中间代码，保存生成的目标代码序列 |
| `RegPool`    | 管理函数的寄存器池，在目标代码需要时设置寄存器 |
| `StackFrame` | 管理函数的栈帧，生成访存指令                   |

其中 `Mips` 为子项目的对外接口，公开方法有

| 方法签名                         | 功能描述                           |
| -------------------------------- | ---------------------------------- |
| `static Mips& getInstance(void)` | 获取单例对象                       |
| `~Mips(void)`                    | 程序结束时自动释放内存             |
| `void init(void)`                | 翻译中间代码并保存                 |
| `void output(void)`              | 将所有中间代码输出至 `mips_output` |

可以看出 `Mips` 的设计采用了单例模式，这样做的目的主要是方便子项目的其他方法查询操作对象。

## Mips 对象

一个 `Mips` 对象内部包含 3 个隐藏属性

| 名称      | 类型                    | 说明                           |
| --------- | ----------------------- | ------------------------------ |
| `_global` | `Sbss*`                 | 全局变量区                     |
| `_str`    | `map<string, string>`   | 由字符串字面量到标签名的映射   |
| `_func`   | `map<string, ObjFunc*>` | 由函数名到目标代码函数体的映射 |

变量类型 `Sbss` 的设计细节会在 `StackFrame` 部分介绍，其主要功能为管理全局变量在 `Sbss` 段的存储结构。属性 `_str` 管理了一个全局字符串池以保证同样的字符串常量共用同一片内存。属性 `_func` 管理了全体函数的目标代码。

初始状态下，属性 `_global` 取值为 `nullptr` 而属性 `_func` 为空。外部函数调用时，需要首先对单例对象执行 `init` 操作。如果对未经 `init` 的对象调用 `output` 会引发异常。执行 `init` 操作分为两个步骤

1. 扫描符号表的 `_global` 域，将所有变量提取出来存放到 `Mips::_global` 中进行内存管理。
2. 遍历符号表中的每个 `_func` 以及 `_main` 所表示的 `FuncTable` 对象，构造 `ObjFunc` 对象。



## 目标代码结构

具体实现时 `Mips::output` 会调用输出函数 `Mips::_output` 以输出目标代码。这个函数的功能有

1. 生成 `.data` 标签
2. 生成字符串标签
3. 生成 `.text` 标签
4. 生成全局调用语句块
5. 生成函数名标签
6. 调用 `ObjFunc::output` 

经过输出的目标代码如下

```mips
.data
str_0: .asciiz ""
# ...

.text
jal func_main
li $v0 10
syscall

func_main:
# ...

func_func1:
# ...
```

在生成函数名标签时，